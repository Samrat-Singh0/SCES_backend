<?xml version="1.0" encoding="UTF-8" ?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      https://www.liquibase.org/xml/ns/dbchangeLog/dbchangeLog-3.8.xsd">

  <changeSet id="2025-06-12-create-user-table" author="Samrat Singh">
    <createTable tableName="user">
      <column name="id" type="BIGINT" autoIncrement="true">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="code" type="VARCHAR(255)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="first_name" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="middle_name" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="last_name" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="email" type="VARCHAR(255)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="password" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="address" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="phone_number" type="VARCHAR(20)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="role" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>
      <column name="must_change_password" type="BOOLEAN">
        <constraints nullable="false"/>
      </column>
      <column name="active_status" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="2025-06-12-create-student-table" author="Samrat Singh">
    <createTable tableName="student">
      <column name="id" type="BIGINT" autoIncrement="true">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="code" type="VARCHAR(255)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="enroll_status" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>
      <column name="user_id" type="BIGINT">
        <constraints nullable="false" foreignKeyName="fk_student_user" referencedTableName="user"
          referencedColumnNames="id"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="2025-06-12-create-instructor-table" author="Samrat Singh">
    <createTable tableName="instructor">
      <column name="id" type="BIGINT" autoIncrement="true">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="code" type="VARCHAR(255)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="user_id" type="BIGINT">
        <constraints nullable="false" foreignKeyName="fk_instructor_user" referencedTableName="user"
          referencedColumnNames="id"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="2025-06-12-create-semester-table" author="Samrat Singh">
    <createTable tableName="semester">
      <column name="id" type="BIGINT" autoIncrement="true">
        <constraints primaryKey="true" nullable="false"/>
      </column>

      <column name="label" type="VARCHAR(255)">
        <constraints nullable="false" unique="true"/>
      </column>

      <column name="fee" type="DECIMAL(19,2)">
        <constraints nullable="false"/>
      </column>

      <column name="start_date" type="DATE">
        <constraints nullable="false"/>
      </column>

      <column name="end_date" type="DATE">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="2025-06-12-create-course-table" author="Samrat Singh">
    <createTable tableName="course">
      <column name="id" type="BIGINT" autoIncrement="true">
        <constraints primaryKey="true" nullable="false"/>
      </column>

      <column name="code" type="VARCHAR(255)">
        <constraints nullable="false" unique="true"/>
      </column>

      <column name="name" type="VARCHAR(255)">
        <constraints nullable="false" unique="true"/>
      </column>

      <column name="credit_hours" type="INT">
        <constraints nullable="false"/>
      </column>

      <column name="full_marks" type="INT">
        <constraints nullable="false"/>
      </column>

      <column name="semester_id" type="BIGINT">
        <constraints nullable="false" foreignKeyName="fk_course_semester"
          referencedTableName="semester" referencedColumnNames="id"/>
      </column>

      <column name="instructor_id" type="BIGINT">
        <constraints nullable="false" foreignKeyName="fk_course_instructor"
          referencedTableName="instructor" referencedColumnNames="id"/>
      </column>

      <column name="checked" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="2025-06-12-create-password-policy-table" author="Samrat Singh">
    <createTable tableName="password_policy">
      <column name="id" type="BIGINT" autoIncrement="true">
        <constraints primaryKey="true" nullable="false"/>
      </column>

      <column name="code" type="VARCHAR(255)">
        <constraints nullable="false" unique="true"/>
      </column>

      <column name="parameters" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>

      <column name="regex" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>

      <column name="active" type="BOOLEAN">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="2025-06-12-create-audit-log-table" author="Samrat Singh">
    <createTable tableName="audit_log">
      <column name="id" type="BIGINT" autoIncrement="true">
        <constraints primaryKey="true" nullable="false"/>
      </column>

      <column name="user_id" type="BIGINT">
        <constraints nullable="false"/>
      </column>

      <column name="action" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>

      <column name="entity_name" type="VARCHAR(255)"/>

      <column name="entity_id" type="BIGINT"/>

      <column name="action_time" type="TIMESTAMP">
        <constraints nullable="false"/>
      </column>

      <column name="details" type="VARCHAR(1000)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addForeignKeyConstraint
      baseTableName="audit_log"
      baseColumnNames="user_id"
      referencedTableName="user"
      referencedColumnNames="id"
      constraintName="fk_audit_log_user"/>
  </changeSet>

  <changeSet id="2025-06-15-add-enrollment-table" author="Samrat Singh">
    <createTable tableName="enrollment">
      <column name="id" type="bigint" autoIncrement="true">
        <constraints primaryKey="true" nullable="false"/>
      </column>

      <column name="student_id" type="bigint">
        <constraints nullable="false" foreignKeyName="fk_enrollment_student"
          referencedTableName="student" referencedColumnNames="id"/>
      </column>

      <column name="semester_id" type="bigint">
        <constraints nullable="false" foreignKeyName="fk_enrollment_semester"
          referencedTableName="semester" referencedColumnNames="id"/>
      </column>

      <column name="enrolled_date" type="date">
        <constraints nullable="false"/>
      </column>

      <column name="completion_date" type="date">
        <constraints nullable="false"/>
      </column>

      <column name="completion_status" type="varchar(255)">
        <constraints nullable="false"/>
      </column>

      <column name="outstanding_fee" type="decimal(19,2)">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="2025-06-15-add-code-in-enrollment" author="Samrat Singh">
    <addColumn tableName="enrollment">
      <column name="code" type="varchar(255)">
        <constraints nullable="false" unique="true"/>
      </column>
    </addColumn>
  </changeSet>

  <changeSet id="2025-06-15-make-completion-date-nullable" author="Samrat Singh">
    <dropNotNullConstraint tableName="enrollment" columnName="completion_date"
      columnDataType="date"/>
  </changeSet>

  <changeSet id="2025-06-16-re-create-enrollment-course" author="Samrat Singh">
    <createTable tableName="enrollment_course">
      <column name="enrollment_id" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="course_id" type="bigint">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addPrimaryKey tableName="enrollment_course" columnNames="enrollment_id, course_id"
      constraintName="pk_enrollment_course"/>

    <addForeignKeyConstraint baseTableName="enrollment_course" baseColumnNames="enrollment_id"
      constraintName="fk_enrollment_course_enrollment"
      referencedTableName="enrollment" referencedColumnNames="id" onDelete="CASCADE"/>

    <addForeignKeyConstraint baseTableName="enrollment_course" baseColumnNames="course_id"
      constraintName="fk_enrollment_course_course"
      referencedTableName="course" referencedColumnNames="id" onDelete="CASCADE"/>
  </changeSet>

  <changeSet id="2025-06-16-add-column-paid-status-in-enrollment" author="Samrat Singh">
    <addColumn tableName="enrollment">
      <column name="paid_status" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
    </addColumn>
  </changeSet>

  <changeSet id="2025-06-17-add-column-remarks-in-user" author="Samrat Singh">
    <addColumn tableName="user">
      <column name="remarks" type="varchar(500)">
      </column>
    </addColumn>
  </changeSet>

</databaseChangeLog>